<!DOCTYPE module SYSTEM "module.dtd">

<module name="logger_sd_spi_direct" dir="loggers">
  <doc>
    <description>Direct SPI SD Logger that saves pprzlog messages to SD Card.</description>
    <configure name="SDLOGGER_DIRECT_SPI_UART" value="UART1|UART2|UART3|UART4|UART5|UART6" description="Port to read back the memory"/>
    <configure name="SDLOGGER_DIRECT_SPI_BAUD" value="B57600"/>
    <configure name="SDLOGGER_DIRECT_SPI" value="SPI1|SPI2|SPI3|SPI4|SPI5|SPI6" description="Port to which the SD Card is connected."/>
    <configure name="SDLOGGER_DIRECT_SPI_SLAVE" value="SPI_SLAVE1|SPI_SLAVE2|SPI_SLAVE3|SPI_SLAVE4|SPI_SLAVE5|SPI_SLAVE6" description="Port to which the SD Card is connected."/>
    <configure name="LOGGER_CONTROL_SWITCH" value="RADIO_AUX2"/>
    <configure name="LOGGER_LED" value="none"/>
  </doc>
  <settings>
    <dl_settings NAME="sdlogger">
      <dl_settings NAME="SD Logger">
        <dl_setting module="loggers/sdlogger_spi_direct" var="sdlogger_spi.status" min="0" max="20" step="1"/>
        <dl_setting module="loggers/sdlogger_spi_direct" var="sdcard1.status" min="0" max="40" step="1"/>
        <dl_setting module="loggers/sdlogger_spi_direct" var="sdlogger_spi.last_completed" min="0" max="42" step="1"/>
        <dl_setting module="loggers/sdlogger_spi_direct" var="sdlogger_spi.next_available_address" min="16384" max="4294967295" step="1" />
        <dl_setting module="loggers/sdlogger_spi_direct" var="sdlogger_spi.command" min="1" max="42" step="1" />
        <dl_setting module="loggers/sdlogger_spi_direct" var="sdlogger_spi.download_address" min="0" max="4294967295" step="1"/>
        <dl_setting module="loggers/sdlogger_spi_direct" var="sdlogger_spi.download_length" min="0" max="4294967295" step="1"/>
        <dl_setting module="loggers/sdlogger_spi_direct" var="sdlogger_spi.download_id" min="0" max="255" step="1"/>
      </dl_settings>
    </dl_settings>
  </settings>
  <header>
    <file name="sdlogger_spi_direct.h"/>
  </header>
  <init fun="sdlogger_spi_direct_init()"/>
  <periodic fun="sdlogger_spi_direct_periodic()" freq="512" start="sdlogger_spi_direct_start()" stop="sdlogger_spi_direct_stop()" autorun="TRUE"/>
  <datalink message="SETTING" fun="sdlogger_spi_direct_command()"/>
  <makefile>

    <raw>
        SDLOGGER_DIRECT_SPI_UART ?= UART1
        SDLOGGER_DIRECT_SPI_BAUD ?= B57600
        SDLOGGER_DIRECT_SPI_UART_LOWER = $(shell echo $(SDLOGGER_DIRECT_SPI_UART) | tr A-Z a-z)
        SDLOGGER_DIRECT_SPI_UART_UPPER = $(shell echo $(SDLOGGER_DIRECT_SPI_UART) | tr a-z A-Z)

        $(TARGET).CFLAGS += -DUSE_$(SDLOGGER_DIRECT_SPI_UART_UPPER)
        $(TARGET).CFLAGS += -D$(SDLOGGER_DIRECT_SPI_UART_UPPER)_BAUD=$(SDLOGGER_DIRECT_SPI_BAUD)
        $(TARGET).CFLAGS += -DSDLOGGER_SPI_DIRECT_DOWNLINK_DEVICE=$(SDLOGGER_DIRECT_SPI_UART_LOWER)

        SDLOGGER_DIRECT_SPI ?= spi2
        SDLOGGER_DIRECT_SPI_LOWER=$(shell echo $(SDLOGGER_DIRECT_SPI) | tr A-Z a-z)
        SDLOGGER_DIRECT_SPI_UPPER=$(shell echo $(SDLOGGER_DIRECT_SPI) | tr a-z A-Z)

        SDLOGGER_DIRECT_SPI_SLAVE ?= spi_slave2
        SDLOGGER_DIRECT_SPI_SLAVE_LOWER=$(shell echo $(SDLOGGER_DIRECT_SPI_SLAVE) | tr A-Z a-z)
        SDLOGGER_DIRECT_SPI_SLAVE_UPPER=$(shell echo $(SDLOGGER_DIRECT_SPI_SLAVE) | tr a-z A-Z)

        LOGGER_CONTROL_SWITCH ?= RADIO_AUX2

        LOGGER_LED ?= none
        ifneq ($(LOGGER_LED),none)
        ap.CFLAGS += -DLOGGER_LED=$(LOGGER_LED)
        endif

        ap.srcs += subsystems/datalink/downlink.c subsystems/datalink/pprzlog_transport.c
    </raw>

    <file name="sdcard_spi.c" dir="peripherals"/>
    <file name="sdlogger_spi_direct.c"/>
  </makefile>
  <makefile target="ap">
    <define name="USE_SDLOGGER_SPI_DIRECT" value="1" />
    <define name="SPI_MASTER" value="1" />
    <define name="USE_$(SDLOGGER_DIRECT_SPI_UPPER)" value="1" />
    <define name="SDLOGGER_SPI_LINK_DEVICE" value="$(SDLOGGER_DIRECT_SPI_LOWER)" />
    <define name="USE_$(SDLOGGER_DIRECT_SPI_SLAVE_UPPER)" value="1" />
    <define name="SDLOGGER_SPI_LINK_SLAVE_NUMBER" value="$(SDLOGGER_DIRECT_SPI_SLAVE_UPPER)" />
    <define name="SDLOGGER_CONTROL_SWITCH" value="$(LOGGER_CONTROL_SWITCH)"/>
  </makefile>
</module>

